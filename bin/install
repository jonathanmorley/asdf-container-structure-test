#!/usr/bin/env bash

set -Eeuo pipefail

# See https://github.com/asdf-vm/asdf/blob/master/docs/plugins-create.md#github-api-rate-limiting
function fetch() {
  curl --verbose --silent --fail --show-error --location ${GITHUB_API_TOKEN:+-H "Authorization: token ${GITHUB_API_TOKEN}"} "$@"
}

if [[ "${ASDF_INSTALL_TYPE:-version}" == 'ref' ]]; then
  echo >&2 "â›” This plugin does not support installing by ref."
  exit 1
fi

if
 [[ "$OSTYPE" == "darwin"* ]]; then
  platform="darwin"
elif [[ "${OSTYPE}" == "linux"* ]]; then
  platform="linux"
else
  echo >&2 "Unsupported platform: ${OSTYPE}."
  exit 1
fi

if [[ $(uname -m) == "x86_64" ]]; then
  arch="amd64"
else
  echo >&2 "Unsupported architecture: $(uname -m)."
  exit 1
fi

mkdir -p "${ASDF_DOWNLOAD_PATH}"

echo "Downloading container-structure-test v${ASDF_INSTALL_VERSION}"

fetch \
  "https://storage.googleapis.com/container-structure-test/v${ASDF_INSTALL_VERSION}/container-structure-test-${platform}-${arch}" \
  -o "${ASDF_DOWNLOAD_PATH}/container-structure-test"
chmod +x "${ASDF_DOWNLOAD_PATH}/container-structure-test"